<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Internal Methods · BlackHole Documentation</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.039/juliamono-regular.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">BlackHole Documentation</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li class="is-active"><a class="tocitem" href>Internal Methods</a><ul class="internal"><li><a class="tocitem" href="#Utility-Methods"><span>Utility Methods</span></a></li><li><a class="tocitem" href="#Rendering-Kernels"><span>Rendering Kernels</span></a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Internal Methods</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Internal Methods</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/fjebaker/BlackHole/blob/master/docs/src/internals.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Internal-Methods"><a class="docs-heading-anchor" href="#Internal-Methods">Internal Methods</a><a id="Internal-Methods-1"></a><a class="docs-heading-anchor-permalink" href="#Internal-Methods" title="Permalink"></a></h1><p>Documentation for methods not exported by the module, included for development purposes.</p><h2 id="Utility-Methods"><a class="docs-heading-anchor" href="#Utility-Methods">Utility Methods</a><a id="Utility-Methods-1"></a><a class="docs-heading-anchor-permalink" href="#Utility-Methods" title="Permalink"></a></h2><article class="docstring"><header><a class="docstring-binding" id="BlackHole.dspher2xyz-Tuple{Any, Any, Any, Any, Any, Any, BlackHole.AccretionDisk}" href="#BlackHole.dspher2xyz-Tuple{Any, Any, Any, Any, Any, Any, BlackHole.AccretionDisk}"><code>BlackHole.dspher2xyz</code></a> — <span class="docstring-category">Method</span></header><section><div><pre><code class="language-julia hljs">dspher2xyz(r, θ, ϕ, dr, dθ, dϕ, disk::AccretionDisk)</code></pre><p>Transform differential coordinates from spherical to cartesian, at a given point <code>r, θ, ϕ</code>, also performing relevant transformation for plane of disk.</p><p>Returns <code>(dx, dy, dz)</code>.</p><p>Takes Jacobian into account. Symbolic expressions originally calculated with SageMaths.</p><p>Complement to <code>dxyz2spher</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/fjebaker/BlackHole/blob/9c3d4e7fe555ea7a69fd63d4dc9311769c787d17/src/utils.jl#L5-L17">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="BlackHole.dxyz2spher-NTuple{6, Any}" href="#BlackHole.dxyz2spher-NTuple{6, Any}"><code>BlackHole.dxyz2spher</code></a> — <span class="docstring-category">Method</span></header><section><div><pre><code class="language-julia hljs">dxyz2spher(x, y, z, dx, dy, dz)</code></pre><p>Transform differential coordinates from cartesian to spherical, at a given point <code>x, y, z</code>.</p><p>Returns <code>(dr, dθ, dϕ)</code>.</p><p>Takes Jacobian into account. Symbolic expressions originally calculated with SageMaths.</p><p>Complement to <code>dspher2xyz</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/fjebaker/BlackHole/blob/9c3d4e7fe555ea7a69fd63d4dc9311769c787d17/src/utils.jl#L52-L63">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="BlackHole.inclination_transform-NTuple{5, Any}" href="#BlackHole.inclination_transform-NTuple{5, Any}"><code>BlackHole.inclination_transform</code></a> — <span class="docstring-category">Method</span></header><section><div><pre><code class="language-julia hljs">inclination_transform(x, y, z, α, β)</code></pre><p>Transform a point on x,y,z to the inclination given by a rotation of α around x, and β around z.</p><p>Returns <code>(x, y, z)</code> in the rotated plane.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/fjebaker/BlackHole/blob/9c3d4e7fe555ea7a69fd63d4dc9311769c787d17/src/utils.jl#L90-L97">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="BlackHole.spher2xyz-NTuple{4, Any}" href="#BlackHole.spher2xyz-NTuple{4, Any}"><code>BlackHole.spher2xyz</code></a> — <span class="docstring-category">Method</span></header><section><div><pre><code class="language-julia hljs">spher2xyz(t, r, θ, ϕ)</code></pre><p>Transform coordinates of a space time point in spherical to cartesian coordinates.</p><p>Returns (t, x, y, z).</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/fjebaker/BlackHole/blob/9c3d4e7fe555ea7a69fd63d4dc9311769c787d17/src/utils.jl#L74-L81">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="BlackHole.truncator-Tuple{Any}" href="#BlackHole.truncator-Tuple{Any}"><code>BlackHole.truncator</code></a> — <span class="docstring-category">Method</span></header><section><div><pre><code class="language-julia hljs">truncator(px)::UInt8</code></pre><p>Clamps value of <code>px</code> between 0 and 255.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/fjebaker/BlackHole/blob/9c3d4e7fe555ea7a69fd63d4dc9311769c787d17/src/utils.jl#L104-L109">source</a></section></article><h2 id="Rendering-Kernels"><a class="docs-heading-anchor" href="#Rendering-Kernels">Rendering Kernels</a><a id="Rendering-Kernels-1"></a><a class="docs-heading-anchor-permalink" href="#Rendering-Kernels" title="Permalink"></a></h2><article class="docstring"><header><a class="docstring-binding" id="BlackHole.kernel_geodesic_render" href="#BlackHole.kernel_geodesic_render"><code>BlackHole.kernel_geodesic_render</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">kernel_geodesic_render(
    indeximage::AbstractArray{T},
    β_store::AbstractArray{&lt;:Number},
    geo_matrix,::AbstractArray{&lt;:Number},
    width::Int, height::Int,
    step_num::Int,
    disk::GeometricDisk,
    max_index::Int
) where T &lt;: Int</code></pre><p>CUDA kernel for computing the integrated paths of geodesics through an accretion disk. <code>indeximage</code> is the result from calling <code>kernel_index_calculator</code>, and is a matrix containing the geodesic index for each pixel.</p><p><code>max_index</code> is the maximal index of the geodesics matrix, i.e. <code>size(geo_matrix, 3)</code>.</p><p>To be launch with <code>threads = 512 blocks = length(indeximage)</code>, until better topology is implemented.</p><p><strong>Extended help</strong></p><p>This kernel works by using one compute block per pixel, and calculating the difference between two points in spacetime along the geodesic per thread. The thread then calculates whether the line length between these points intersects the accretion disk, and sets a value in a shared memory buffer: in essense, each thread calculates</p><pre><code class="language-jl hljs">    geodesics[:, thread + 1, geoindex] - geodesics[:, thread, geoindex]</code></pre><p>transformed by the angles of the accretion disk. This allows the intersection to be calculated from the <span>$z$</span> component: <span>$0 \leq \frac{z_i}{z_i - z_{i+1}} &lt; 1$</span></p><p>Internally, the offsets are mapped with the column major formula</p><pre><code class="nohighlight hljs">n x m x p:
    arr[i, j, k] == arr[(n*m)*(k-1) + n*(j-1) + i]</code></pre><p>to avoid <code>getindex</code> function calls.</p><p>At the end of the kernel, a simple reduce algorithm is implemented to sum over the shared array. The first thread of each block then stores the value back into <code>indeximage</code> as the output of the kernel.</p><p>Better topology for this kernel would have the y dimension continue to calculate the same pixel, incase there are more geodesic integration steps (<code>step_num</code>) than threads can be spawned. Due to the size of this kernel, only about <code>512</code> threads can be spawned on my hardware before the device runs out of resources.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/fjebaker/BlackHole/blob/9c3d4e7fe555ea7a69fd63d4dc9311769c787d17/src/gpu.jl#L63-L113">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="BlackHole.kernel_index_calculator" href="#BlackHole.kernel_index_calculator"><code>BlackHole.kernel_index_calculator</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">function kernel_index_calculator(
    oimg::AbstractArray{Int},
    β_store::AbstractArray{&lt;:Number},
    width::Int,
    height::Int,
    fov::Int,
    num_geodesics::Int
)</code></pre><p>CUDA kernel for calculating which index of the geodesic array to use in each pixel. The index calculated for a given <code>y, x</code> position is stored in <code>oimg[y, x]</code>. <code>β_store[y, x]</code> also stores the corresponding pixel&#39;s angle around the <code>x</code> axis, used for calculating inclination into the accretion disk in the second kernel (<code>kernel_geodesic_render</code>).</p><p><code>fov</code> is a &quot;field of view&quot; index, used to adjust which pixel maps to the end of the geodesic array (<code>num_geodesics</code>). As a rough guideline, <code>fov=1000</code> maps the pixel at distance <code>r=1000</code> to the last index of the geodesic array.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/fjebaker/BlackHole/blob/9c3d4e7fe555ea7a69fd63d4dc9311769c787d17/src/gpu.jl#L3-L21">source</a></section></article></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../">« Home</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.6 on <span class="colophon-date" title="Wednesday 15 September 2021 15:55">Wednesday 15 September 2021</span>. Using Julia version 1.6.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
